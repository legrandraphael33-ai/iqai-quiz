<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>IQAI Test - I Quit AI</title>

  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box;margin:0;padding:0;}
    :root{
      --title-font:'Press Start 2P', monospace;
      --body-font:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    body{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      background: linear-gradient(135deg,#f0c79e,#e3a56b);
      padding:20px;
      font-family: var(--body-font);
    }

    h1{
      font-family: var(--title-font);
      font-size:2.25em;
      margin-bottom:8px;
      text-align:center;
      line-height:1.15;
      letter-spacing:0.5px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.18);
    }
    h1 span{display:inline-block;}
    .title-sep{margin:0 10px;opacity:0.92;transform:translateY(-1px);}

    p.subtitle{
      text-align:center;
      margin-bottom:24px;
      font-size:1.45em;
      font-weight:800;
      color:#ffffff;
      text-shadow:0 3px 12px rgba(0,0,0,0.28);
      letter-spacing:0.2px;
    }

    .container{
      max-width:560px;width:100%;
      background:#ffffff;color:#333;
      border-radius:18px;
      padding:26px;
      box-shadow:0 10px 28px rgba(0,0,0,0.18);
    }

    .question{
      margin-bottom:14px;
      font-weight:800;
      font-size:1.05em;
      line-height:1.35;
    }

    .options button{
      margin:6px 0;
      width:100%;
      padding:12px 14px 12px 44px;
      border:none;
      border-radius:12px;
      background:#ff8f00;
      color:#fff;
      cursor:pointer;
      font-weight:800;
      transition:0.2s;
      position:relative;
      text-align:left;
      font-family:var(--body-font);
      font-size:1em;
    }
    .options button:hover{background:#f57c00;}

    /* Surbrillance s√©lection (sans indiquer vrai/faux) */
    .options button.selected{
      background:#263238 !important;
      outline:3px solid rgba(255,143,0,0.55);
      box-shadow:0 8px 18px rgba(0,0,0,0.15);
      transform:translateY(1px);
    }
    .options button::before{
      content:"";
      position:absolute;left:12px;top:50%;
      transform:translateY(-50%);
      width:20px;height:20px;border-radius:6px;
      border:2px solid rgba(255,255,255,0.85);
      background:rgba(255,255,255,0.12);
    }
    .options button.selected::before{
      content:"‚úì";
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:#fff;
      background:rgba(255,255,255,0.25);
    }

    #nextBtn{
      margin-top:12px;width:100%;
      padding:12px;border:none;border-radius:12px;
      background:#263238;color:#fff;
      cursor:pointer;font-weight:800;
      transition:0.2s;
      font-family:var(--body-font);
      font-size:1em;
    }
    #nextBtn:hover{filter:brightness(1.05);}
    #nextBtn:disabled{opacity:0.55;cursor:not-allowed;}

    .score,.streak,.feedback{text-align:center;margin-top:10px;}
    .feedback{font-style:italic;color:#27ae60;font-weight:800;}

    .hidden{display:none;}

    /* Review + tags */
    #reviewContainer{margin-top:18px;}
    #reviewContainer h3{margin:8px 0 10px;font-size:1.05em;}
    .reviewItem{
      padding:10px 12px;
      border:1px solid rgba(0,0,0,0.08);
      border-radius:12px;margin-bottom:10px;
      background:rgba(0,0,0,0.02);
      line-height:1.35;
      font-size:0.98em;
    }

    .answerTag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-weight:900;
      line-height:1.2;
    }
    .answerTag.ok{
      background: rgba(39,174,96,0.12);
      border: 1px solid rgba(39,174,96,0.35);
      color:#1f7a3f;
    }
    .answerTag.bad{
      background: rgba(255,60,120,0.14);
      border: 1px solid rgba(255,60,120,0.40);
      color:#a8164a;
    }

    .errorBox{
      margin-top:10px;
      padding:12px;
      border-radius:12px;
      background:#fff3f3;
      border:1px solid rgba(255,0,0,0.15);
      color:#8a1f1f;
      font-weight:700;
      line-height:1.35;
      font-size:0.98em;
    }

    /* Token container */
    #tokenContainer{
      margin:20px auto 0;
      padding:16px;
      background:#fff;
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,0.15);
      max-width:420px;
      text-align:center;
    }
    #tokenImage{
      width:100%;
      border-radius:12px;
      display:block;
    }
    #tokenCanvas{
      width:100%;
      border-radius:12px;
      display:block;
    }

    #shareBtn{
      margin-top:16px;
      width:100%;
      padding:12px 16px;
      background:#0077b5;
      color:#fff;
      border:none;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
      font-size:1em;
      transition:0.2s;
    }
    #shareBtn:hover{background:#005885;}

    #restartBtn{
      margin-top:12px;width:100%;
      padding:12px;border:none;border-radius:12px;
      background:#37474f;color:#fff;cursor:pointer;font-weight:900;
    }
    /* --- Boot: letters light up (one-shot) --- */
#title span{
  display:inline-block;
  animation: bootLight 800ms ease-out both;
  animation-delay: calc(var(--i) * 60ms);
  will-change: filter, opacity, transform;
}

@keyframes bootLight{
  0%   { opacity: 0; transform: translateY(6px) scale(0.98); filter: grayscale(1) brightness(0.2) blur(1px); }
  60%  { opacity: 1; transform: translateY(0) scale(1); filter: grayscale(0.7) brightness(1.2); }
  100% { opacity: 1; transform: translateY(0) scale(1); filter: grayscale(0) brightness(1) blur(0); }
}
    @media (max-width: 480px) {
    h1#title {
      font-size: 1.4em;
      white-space: nowrap;
      transform: scale(0.95);
    }
  }

  </style>
</head>

<body>
  <h1 id="title"></h1>
  <p class="subtitle">I Quit AI</p>

  <div class="container">
    <div id="quiz">
      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>
      <button id="nextBtn" disabled>Suivant</button>
      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">
      <p class="score" id="scoreDisplay"></p>
      <p class="feedback" id="feedbackDisplay"></p>
      <p class="streak" id="streakDisplay"></p>

      <!-- ‚úÖ UN SEUL token zone (plus d'ancien token parasite) -->
      <div id="tokenContainer" class="hidden">
        <img id="tokenImage" class="hidden" alt="" />
        <canvas id="tokenCanvas" class="hidden" width="500" height="250"></canvas>
      </div>

      <button id="shareBtn" class="hidden">Partager sur LinkedIn</button>
      <div id="reviewContainer"></div>
      <button id="restartBtn">Rejouer maintenant</button>
    </div>
  </div>

  <script>
    // ========= TITLE =========
    const colors = ["#FF4136","#FFDC00","#2ECC40","#0074D9","#FF851B","#B10DC9"];
    const titleContainer = document.getElementById("title");
    const parts = ["IQAI", "Test"];
    let colorIndex = 0;

   function addColored(text){
  text.split("").forEach((c,i)=>{
    const s = document.createElement("span");
    s.textContent = c;
    s.style.opacity = "0";
    s.style.transform = "scale(0.8)";
    s.style.transition = "opacity 0.4s ease, transform 0.4s ease";
    s.style.color = colors[(colorIndex+i)%colors.length];

    titleContainer.appendChild(s);

    // üéÆ Effet Game Boy (allumage lettre par lettre)
    setTimeout(() => {
      s.style.opacity = "1";
      s.style.transform = "scale(1)";
    }, 180 * i); // ‚Üê ajuste ici si tu veux plus lent (200) ou plus rapide (140)
  });

  colorIndex += text.length;
}


    titleContainer.innerHTML = "";
    addColored(parts[0]);
    const sep=document.createElement("span");
    sep.textContent=" | ";
    sep.className="title-sep";
    sep.style.color="rgba(255,255,255,0.92)";
    titleContainer.appendChild(sep);
    addColored(parts[1]);

    // ========= CONFIG =========
    const API_URL = "https://iqai-backend.vercel.app/api/quiz";

    // ========= STATE =========
    let questions = [];
    let current = 0;
    let score = 0;
    let userAnswers = [];

    // ========= DOM =========
    const questionContainer = document.getElementById("questionContainer");
    const optionsContainer  = document.getElementById("optionsContainer");
    const nextBtn           = document.getElementById("nextBtn");
    const quizDiv           = document.getElementById("quiz");
    const resultDiv         = document.getElementById("result");

    const scoreDisplay      = document.getElementById("scoreDisplay");
    const feedbackDisplay   = document.getElementById("feedbackDisplay");
    const streakDisplay     = document.getElementById("streakDisplay");

    const tokenContainer    = document.getElementById("tokenContainer");
    const tokenImage        = document.getElementById("tokenImage");
    const tokenCanvas       = document.getElementById("tokenCanvas");

    const shareBtn          = document.getElementById("shareBtn");
    const restartBtn        = document.getElementById("restartBtn");
    const reviewContainer   = document.getElementById("reviewContainer");
    const errorContainer    = document.getElementById("errorContainer");

    // ========= STREAK =========
    const todayKey = new Date().toDateString();
    let streak = parseInt(localStorage.getItem("streak") || "0", 10);
    let lastPlayed = localStorage.getItem("lastPlayed");
    if (lastPlayed !== todayKey && lastPlayed !== new Date(Date.now()-86400000).toDateString()) streak = 0;

    // ========= ERRORS =========
    function showError(msg){
      errorContainer.classList.remove("hidden");
      errorContainer.className = "errorBox";
      errorContainer.textContent = msg;
    }
    function clearError(){
      errorContainer.classList.add("hidden");
      errorContainer.className = "";
      errorContainer.textContent = "";
    }

    // ========= AVOID (anti-r√©p√©tition) =========
    function getAvoidList(){
      try{
        const raw = localStorage.getItem("iqai_avoid") || "[]";
        const arr = JSON.parse(raw);
        return Array.isArray(arr) ? arr.slice(-60) : [];
      }catch{
        return [];
      }
    }
    function pushAvoidFromQuiz(quiz){
      try{
        const avoid = getAvoidList();
        quiz.forEach(q => {
          const txt = String(q.q || "").trim();
          if (txt) avoid.push(txt);
        });
        localStorage.setItem("iqai_avoid", JSON.stringify(avoid.slice(-200)));
      }catch{}
    }

    // ========= NORMALIZE =========
    function normalizeQuiz(raw){
      if (!Array.isArray(raw)) return null;

      const arr = raw.slice(0, 10).map(x => ({
        q: String(x.q ?? "").trim(),
        options: Array.isArray(x.options) ? x.options.map(o => String(o).trim()).slice(0,4) : [],
        answer: String(x.answer ?? "").trim(),
        explanation: String(x.explanation ?? "").trim()
      })).filter(x => x.q && x.options.length === 4 && x.answer);

      return (arr.length === 10) ? arr : null;
    }

    // ========= LOAD =========
    async function loadQuestions(){
      const avoid = getAvoidList();

      const res = await fetch(API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        cache: "no-store",
        body: JSON.stringify({ avoid })
      });

      if(!res.ok){
        throw new Error("Le backend ne r√©pond pas (HTTP " + res.status + ").");
      }

      const raw = await res.json();
      const quiz = normalizeQuiz(raw);

      if(!quiz || quiz.length !== 10){
        throw new Error("Le quiz re√ßu est invalide. R√©essaie.");
      }

      questions = quiz;
      pushAvoidFromQuiz(quiz);
    }

    // ========= UI =========
    function showQuestion(){
      clearError();
      const q = questions[current];

      questionContainer.innerHTML = `<div class="question">${current+1}. ${q.q}</div>`;
      optionsContainer.innerHTML = "";

      nextBtn.disabled = (userAnswers[current] == null);
      nextBtn.textContent = (current === questions.length - 1) ? "Terminer" : "Suivant";

      q.options.forEach(opt=>{
        const btn = document.createElement("button");
        btn.textContent = opt;

        if (userAnswers[current] === opt) btn.classList.add("selected");

        btn.onclick = () => {
          userAnswers[current] = opt;
          Array.from(optionsContainer.children).forEach(b=>{
            b.classList.toggle("selected", b.textContent === opt);
          });
          nextBtn.disabled = false;
        };

        optionsContainer.appendChild(btn);
      });
    }

    nextBtn.onclick = () => {
      const selected = userAnswers[current];
      if (selected === questions[current].answer) score++;
      current++;

      if (current < questions.length) showQuestion();
      else showResult();
    };

    // ========= TOKENS =========
    function drawMidToken(score){
      const ctx = tokenCanvas.getContext("2d");
      ctx.clearRect(0,0,500,250);

      const grad = ctx.createLinearGradient(0,0,500,250);
      grad.addColorStop(0, "#4facfe");
      grad.addColorStop(1, "#00f2fe");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,500,250);

      ctx.fillStyle = "#1a1a1a";
      ctx.textAlign = "center";
      ctx.font = "bold 28px 'Press Start 2P'";
      ctx.fillText("I QUIT AI üö™", 250, 95);

      ctx.font = "18px 'Press Start 2P'";
      ctx.fillText(`Score: ${score}/10`, 250, 145);

      ctx.font = "16px Inter";
      ctx.fillText("Keep going! üí™", 250, 190);
    }

    function drawPerfectToken(streak){
      const ctx = tokenCanvas.getContext("2d");
      ctx.clearRect(0,0,500,250);

      const grad = ctx.createLinearGradient(0,0,500,250);
      grad.addColorStop(0, "#f7d24c");
      grad.addColorStop(1, "#ff9f1a");
      ctx.fillStyle = grad;
      ctx.fillRect(0,0,500,250);

      ctx.fillStyle = "rgba(0,0,0,0.1)";
      ctx.beginPath();
      ctx.arc(420, 70, 50, 0, Math.PI*2);
      ctx.fill();

      ctx.fillStyle = "#1f2a30";
      ctx.textAlign = "center";
      ctx.font = "bold 26px 'Press Start 2P'";
      ctx.fillText("üèÜ CERTIFIED üèÜ", 250, 80);

      ctx.font = "bold 22px 'Press Start 2P'";
      ctx.fillText("SAFE BRAIN", 250, 130);

      ctx.font = "16px 'Press Start 2P'";
      ctx.fillText(`Streak: ${streak} days`, 250, 180);

      ctx.font = "14px Inter";
      ctx.fillText(new Date().toLocaleDateString("fr-FR"), 250, 220);
    }

    function showResult(){
      quizDiv.classList.add("hidden");
      resultDiv.classList.remove("hidden");

      scoreDisplay.textContent = `Votre score : ${score} / ${questions.length}`;
      feedbackDisplay.textContent =
        score === questions.length ? "Parfait ! Vous √™tes un g√©nie !" :
        score >= 7 ? "Tr√®s solide. Reviens demain." :
        score >= 4 ? "Bien jou√©, continue." :
        "Courage. Reviens demain.";

      // Streak
      streak++;
      localStorage.setItem("streak", String(streak));
      localStorage.setItem("lastPlayed", todayKey);
      streakDisplay.textContent = `Streak actuel : ${streak} jours`;

      // ===== TOKENS (‚úÖ un seul token visible selon score) =====
      tokenContainer.classList.remove("hidden");

      // reset token area
      tokenImage.classList.add("hidden");
      tokenImage.removeAttribute("src");
      tokenCanvas.classList.add("hidden");
      tokenCanvas.getContext("2d").clearRect(0,0,500,250);

      if (score < 6) {
        // ‚úÖ Michael Scott only
        tokenImage.classList.remove("hidden");
        tokenImage.src = "./ai-brainwashed.jpg";
        tokenImage.alt = "AI BRAINWASHED";
      } else if (score < 10) {
        tokenCanvas.classList.remove("hidden");
        drawMidToken(score);
      } else {
        tokenCanvas.classList.remove("hidden");
        drawPerfectToken(streak);
      }

      // ===== Share button =====
      shareBtn.classList.remove("hidden");
      shareBtn.textContent =
        score < 6 ? "Partage le jeu avec tes amis (et sauve-les de l'IA !)" :
        score < 10 ? "Partage ton score et challenge tes amis !" :
        "Partage ton cerveau certifi√© 100% humain !";

      shareBtn.onclick = () => {
        const messages = {
          low: `üß†üí• J'ai fait ${score}/10 au IQAI Test... L'IA m'a eu ! Essaie de faire mieux : `,
          mid: `üß†‚úÖ Score de ${score}/10 au IQAI Test ! Je r√©siste √† l'IA. √Ä ton tour : `,
          perfect: `üèÜ 10/10 au IQAI Test ! Cerveau 100% humain certifi√©. Streak: ${streak} jours. Challenge-toi : `
        };
        const text = score < 6 ? messages.low : score < 10 ? messages.mid : messages.perfect;
        const url = "https://www.linkedin.com/sharing/share-offsite/?url=" +
          encodeURIComponent(window.location.href) +
          "&summary=" + encodeURIComponent(text);
        window.open(url, "_blank");
      };

      // ===== Review =====
      reviewContainer.innerHTML = "<h3>Review des questions</h3>";
      questions.forEach((q, i) => {
        const user = userAnswers[i];
        const isOk = (user != null && user === q.answer);

        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <strong>Q${i+1}:</strong> ${q.q}<br>
          <strong>Votre r√©ponse:</strong>
            <span class="answerTag ${isOk ? "ok" : "bad"}">${user ?? "‚Äî"}</span><br>
          <strong>Bonne r√©ponse:</strong>
            <span class="answerTag ok">${q.answer}</span><br>
          <em>Explication:</em> ${q.explanation}
        `;
        reviewContainer.appendChild(div);
      });
    }

    // ========= START / RESTART =========
    async function startGame(){
      clearError();

      // reset UI
      resultDiv.classList.add("hidden");
      quizDiv.classList.remove("hidden");

      // reset token + share + review
      tokenContainer.classList.add("hidden");
      tokenImage.classList.add("hidden");
      tokenImage.removeAttribute("src");
      tokenCanvas.classList.add("hidden");
      shareBtn.classList.add("hidden");
      reviewContainer.innerHTML = "";

      current = 0;
      score = 0;
      nextBtn.disabled = true;
      optionsContainer.innerHTML = "";
      questionContainer.innerHTML = `<div class="question">Chargement du quiz...</div>`;

      try{
        await loadQuestions();
        userAnswers = new Array(questions.length).fill(null);
        showQuestion();
      } catch (e) {
        showError("Erreur de chargement du quiz. Recharge la page ou r√©essaie. (" + (e?.message || e) + ")");
        questionContainer.innerHTML = `<div class="question">Impossible de charger le quiz.</div>`;
        nextBtn.disabled = true;
      }
    }

    restartBtn.onclick = async () => { await startGame(); };
    window.addEventListener("DOMContentLoaded", () => { startGame(); });
  </script>
</body>
</html>
