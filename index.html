<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IQAI Test - I Quit AI</title>
<link rel="icon" href="data:,">

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  :root{
    --title-font:'Press Start 2P', monospace;
    --body-font:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  body{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    background: linear-gradient(135deg,#f0c79e,#e3a56b);
    padding:20px;
    font-family: var(--body-font);
  }

  h1{
    font-family: var(--title-font);
    font-size:2.25em;
    margin-bottom:8px;
    text-align:center;
    line-height:1.15;
    letter-spacing:0.5px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.18);
    white-space: nowrap;
  }
  h1 span{display:inline-block;}

  .title-sep{
    margin:0 10px;
    opacity:0;
    transform:translateY(-1px);
    color: rgba(255,255,255,0.92);
  }
  .title-sep.cursor-on{
    opacity:0.92;
    animation: caretBlink 1.7s steps(1,end) infinite;
  }
  @keyframes caretBlink{
    0%,49%{opacity:0.92;}
    50%,100%{opacity:0;}
  }

  p.subtitle{
    text-align:center;
    margin-bottom:24px;
    font-size:1.45em;
    font-weight:800;
    color:#ffffff;
    text-shadow:0 3px 12px rgba(0,0,0,0.28);
    letter-spacing:0.2px;
  }

  .container{
    max-width:560px;width:100%;
    background:#ffffff;color:#333;
    border-radius:18px;
    padding:26px;
    box-shadow:0 10px 28px rgba(0,0,0,0.18);
  }

  .question{
    margin-bottom:14px;
    font-weight:800;
    font-size:1.05em;
    line-height:1.35;
  }

  .options button{
    margin:6px 0;
    width:100%;
    padding:12px 14px 12px 44px;
    border:none;
    border-radius:12px;
    background:#ff8f00;
    color:#fff;
    cursor:pointer;
    font-weight:800;
    transition:0.2s;
    position:relative;
    text-align:left;
    font-family:var(--body-font);
    font-size:1em;
  }
  .options button:hover{background:#f57c00;}

  .options button.selected{
    background:#263238 !important;
    outline:3px solid rgba(255,143,0,0.55);
    box-shadow:0 8px 18px rgba(0,0,0,0.15);
    transform:translateY(1px);
  }
  .options button::before{
    content:"";
    position:absolute;left:12px;top:50%;
    transform:translateY(-50%);
    width:20px;height:20px;border-radius:6px;
    border:2px solid rgba(255,255,255,0.85);
    background:rgba(255,255,255,0.12);
  }
  .options button.selected::before{
    content:"‚úì";
    display:flex;align-items:center;justify-content:center;
    font-weight:900;color:#fff;
    background:rgba(255,255,255,0.25);
  }

  #nextBtn{
    margin-top:12px;width:100%;
    padding:12px;border:none;border-radius:12px;
    background:#263238;color:#fff;
    cursor:pointer;font-weight:800;
    transition:0.2s;
    font-family:var(--body-font);
    font-size:1em;
  }
  #nextBtn:hover{filter:brightness(1.05);}
  #nextBtn:disabled{opacity:0.55;cursor:not-allowed;}

  .score,.streak,.feedback{text-align:center;margin-top:10px;}
  .feedback{font-style:italic;color:#27ae60;font-weight:800;}

  #shareBtn{
    margin-top:10px;padding:10px 15px;
    background:#0077b5;color:#fff;border:none;border-radius:10px;
    cursor:pointer;font-weight:900;
    display:block;margin-left:auto;margin-right:auto;
  }
  #restartBtn{
    margin-top:12px;width:100%;
    padding:12px;border:none;border-radius:12px;
    background:#37474f;color:#fff;cursor:pointer;font-weight:900;
  }

  .hidden{display:none;}

  #reviewContainer{margin-top:18px;}
  #reviewContainer h3{margin:8px 0 10px;font-size:1.05em;}
  .reviewItem{
    padding:10px 12px;
    border:1px solid rgba(0,0,0,0.08);
    border-radius:12px;margin-bottom:10px;
    background:rgba(0,0,0,0.02);
    line-height:1.35;
    font-size:0.98em;
  }

  .errorBox{
    margin-top:10px;
    padding:12px;
    border-radius:12px;
    background:#fff3f3;
    border:1px solid rgba(255,0,0,0.15);
    color:#8a1f1f;
    font-weight:700;
    line-height:1.35;
    font-size:0.98em;
  }

  .answerTag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-weight:900;
    line-height:1.2;
  }
  .answerTag.ok{
    background: rgba(39,174,96,0.12);
    border: 1px solid rgba(39,174,96,0.35);
    color:#1f7a3f;
  }
  .answerTag.bad{
    background: rgba(255,60,120,0.14);
    border: 1px solid rgba(255,60,120,0.40);
    color:#a8164a;
  }

  /* HALU tag */
  .haluBanner{
    margin-top:8px;
    padding:8px 10px;
    border-radius:12px;
    font-weight:900;
    background: rgba(255, 60, 120, 0.12);
    border: 1px solid rgba(255, 60, 120, 0.35);
    color:#a8164a;
  }

/* ===== TOKENS (fix canvas) ===== */
#tokenContainer{
  width: min(520px, 100%);
  margin: 20px auto;
  padding: 12px;
  background: #fff;
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  overflow: hidden;              /* emp√™che tout d√©bordement */
}

#tokenImage{
  display:block;
  width:100%;
  height:auto;
  border-radius:14px;
  object-fit: cover;
}

#tokenCanvas{
  display:block;
  width:100%;                    /* important */
  height:auto;
  border-radius:14px;
}




  #shareBtn:hover { background: #005885; }

  #startBtn{
    width:100%;
    padding:16px;
    font-size:1.05em;
    font-weight:900;
    border:none;
    border-radius:14px;
    background: linear-gradient(#2f3a41, #1f2a30);
    color:#fff;
    cursor:pointer;
    transition:0.2s;
    font-family: var(--title-font);
    letter-spacing:0.5px;
    box-shadow:
      inset 0 2px 0 rgba(255,255,255,0.12),
      inset 0 -3px 0 rgba(0,0,0,0.25),
      0 10px 28px rgba(0,0,0,0.18);
    border: 2px solid rgba(255,255,255,0.12);
  }
  #startBtn:active{
    transform: translateY(2px);
    box-shadow:
      inset 0 2px 0 rgba(255,255,255,0.10),
      inset 0 -2px 0 rgba(0,0,0,0.22),
      0 6px 18px rgba(0,0,0,0.18);
  }
  #startBtn:hover{filter:brightness(1.05);}

  #timerLine{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  #timerDisplay{
    font-family: var(--title-font);
    font-size: 0.82em;
    color: #1f2a30;
    background: rgba(255, 143, 0, 0.18);
    border: 2px solid rgba(255, 143, 0, 0.45);
    box-shadow: inset 0 2px 0 rgba(255,255,255,0.35);
    padding: 7px 12px;
    border-radius: 999px;
  }
  #timerDisplay.timer-urgent{
    background: rgba(255, 60, 120, 0.16);
    border-color: rgba(255, 60, 120, 0.55);
    color: #a8164a;
  }

  /* Bouton "J‚Äôai un doute" */
  #doubtBtn{
    margin-top:10px;
    width:100%;
    padding:12px;
    border-radius:12px;
    border:2px dashed rgba(255,143,0,0.8);
    background:#fff3e0;
    font-weight:900;
    cursor:pointer;
    font-family: var(--body-font);
  }
  #doubtBtn:active{transform: translateY(1px);}
  #doubtBtn:disabled{opacity:0.55;cursor:not-allowed;}

  @media (max-width: 420px){
    h1{font-size:1.45em;letter-spacing:0.2px;}
    .title-sep{margin:0 6px;}
    p.subtitle{font-size:1.15em;}
  }
</style>
</head>

<body>
  <h1 id="title"></h1>
  <p class="subtitle">I Quit AI</p>

  <div id="startScreen" class="container">
    <h2 style="text-align:center;margin-bottom:16px;font-weight:900;">Appuie pour d√©marrer</h2>
    <button id="startBtn">‚ñ∂ START</button>
  </div>

  <div class="container hidden" id="gameContainer">
    <div id="quiz">
      <div id="timerLine">
        <div></div>
        <div id="timerDisplay" class="hidden">‚è± 30</div>
      </div>

      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>

      <button id="nextBtn" disabled>Suivant</button>
      <button id="doubtBtn" class="hidden">ü§î J‚Äôai un doute</button>

      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">
      <p class="score" id="scoreDisplay"></p>
     <p class="streak" id="vigilanceDisplay"></p>
      <p class="feedback" id="feedbackDisplay"></p>
      <p class="streak" id="gamesPlayedDisplay"></p>

      <div id="tokenContainer" class="hidden" >
        <img id="tokenImage" class="hidden" style="width:100%; border-radius:14px;" />
        <canvas id="tokenCanvas" class="hidden" width="500" height="250"></canvas>
      </div>

      <button id="shareBtn">Partager sur LinkedIn</button>
      <div id="reviewContainer"></div>
      <button id="restartBtn">Rejouer demain</button>
    </div>
  </div>

  <audio id="bootSound" preload="auto" playsinline>
    <source src="Gameboy.mp3" type="audio/mpeg">
  </audio>

<script>
  // ---------- TITLE ----------
  const colors=["#FF4136","#FFDC00","#2ECC40","#0074D9","#FF851B","#B10DC9"];
  const titleContainer=document.getElementById("title");
  const parts=["IQAI","Test"];

  let cursorSepEl=null;
  let cursorTimeoutId=null;
  let hasShownCursor=false;

  function clearTitle(){
    titleContainer.innerHTML="";
    cursorSepEl=null;
    hasShownCursor=false;
    if(cursorTimeoutId){clearTimeout(cursorTimeoutId);cursorTimeoutId=null;}
  }
  function showCursorBlink(){
    if(hasShownCursor) return;
    if(cursorSepEl){
      cursorSepEl.classList.add("cursor-on");
      hasShownCursor=true;
    }
  }
  function animateTitle({ letterDelayMs=140, initialDelayMs=80 }={}){
    clearTitle();

    const spans=[];
    let colorIndex=0;

    function addColoredText(text){
      text.split("").forEach((c,i)=>{
        const s=document.createElement("span");
        s.textContent=c;
        s.style.opacity="0";
        s.style.transform="scale(0.85)";
        s.style.transition="opacity 180ms ease, transform 180ms ease";
        s.style.color=colors[(colorIndex+i)%colors.length];
        spans.push(s);
        titleContainer.appendChild(s);
      });
      colorIndex+=text.length;
    }

    addColoredText(parts[0]);

    cursorSepEl=document.createElement("span");
    cursorSepEl.className="title-sep";
    cursorSepEl.textContent="|";
    titleContainer.appendChild(cursorSepEl);

    addColoredText(parts[1]);

    spans.forEach((s,i)=>{
      setTimeout(()=>{
        s.style.opacity="1";
        s.style.transform="scale(1)";
      }, initialDelayMs + (i*letterDelayMs));
    });

    return initialDelayMs + (spans.length*letterDelayMs) + 220;
  }

  // ---------- STATE ----------
  const API_URL="https://iqai-backend.vercel.app/api/quiz";
  let questions=[];
  let current=0;
  let score=0;       // score "connaissance" (safe only)
  let vigilance=0;   // score "hallu d√©tect√©es"
  let userAnswers=[];

  // Timer
  const QUESTION_TIME=30;
  let timeLeft=QUESTION_TIME;
  let timerId=null;

  // ---------- DOM ----------
  const questionContainer=document.getElementById('questionContainer');
  const optionsContainer=document.getElementById('optionsContainer');
  const nextBtn=document.getElementById('nextBtn');
  const doubtBtn=document.getElementById('doubtBtn');
  const quizDiv=document.getElementById('quiz');
  const resultDiv=document.getElementById('result');

  const scoreDisplay=document.getElementById('scoreDisplay');
  const feedbackDisplay=document.getElementById('feedbackDisplay');
  const gamesPlayedDisplay=document.getElementById('gamesPlayedDisplay');
 const vigilanceDisplay = document.getElementById('vigilanceDisplay');

  const shareBtn=document.getElementById('shareBtn');
  const restartBtn=document.getElementById('restartBtn');
  const reviewContainer=document.getElementById('reviewContainer');
  const errorContainer=document.getElementById('errorContainer');

  const timerDisplay=document.getElementById("timerDisplay");

  const startScreen=document.getElementById("startScreen");
  const startBtn=document.getElementById("startBtn");
  const gameContainer=document.getElementById("gameContainer");
  const bootSound=document.getElementById("bootSound");

  let gamesPlayed=parseInt(localStorage.getItem("gamesPlayed")||"0",10);

  // ---------- HELPERS ----------
  function showError(msg){
    errorContainer.classList.remove('hidden');
    errorContainer.className="errorBox";
    errorContainer.textContent=msg;
  }
  function clearError(){
    errorContainer.classList.add('hidden');
    errorContainer.className="";
    errorContainer.textContent="";
  }

  function normalizeQuiz(raw){
    if(!Array.isArray(raw)) return null;
    const arr=raw.slice(0,10).map(x=>({
      q:String(x.q??""),
      options:Array.isArray(x.options)?x.options.map(String).slice(0,4):[],
      answer:String(x.answer??""),
      explanation:String(x.explanation??""),
      kind:String(x.kind??"safe") // "safe" ou "halu"
    })).filter(x=>x.q && x.options.length===4 && x.answer);
    return (arr.length===10)?arr:null;
  }

  async function fetchWithTimeout(url, options={}, ms=30000){
    const controller=new AbortController();
    const id=setTimeout(()=>controller.abort(), ms);
    try{
      return await fetch(url,{...options, signal:controller.signal});
    } finally {
      clearTimeout(id);
    }
  }

  async function loadQuestions(){
    const opts={
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      cache:"no-store",
      body: JSON.stringify({})
    };

    let res;
    try{
      res=await fetchWithTimeout(API_URL, opts, 30000);
    }catch(e){
      res=await fetchWithTimeout(API_URL, opts, 35000);
    }

    if(!res || !res.ok) throw new Error("Le backend ne r√©pond pas (HTTP "+(res?res.status:"‚Äî")+").");

    const raw=await res.json();
    const quiz=normalizeQuiz(raw);
    if(!quiz) throw new Error("Quiz invalide.");
    questions=quiz;
  }

  // ---------- TIMER ----------
  function stopTimer(){
    if(timerId){clearInterval(timerId);timerId=null;}
  }
  function startTimer(){
    stopTimer();
    timeLeft=QUESTION_TIME;
    timerDisplay.classList.remove("hidden");
    timerDisplay.textContent=`‚è± ${timeLeft}`;
    timerDisplay.classList.remove("timer-urgent");

    timerId=setInterval(()=>{
      timeLeft--;
      timerDisplay.textContent=`‚è± ${timeLeft}`;

      if(timeLeft<=10) timerDisplay.classList.add("timer-urgent");
      else timerDisplay.classList.remove("timer-urgent");

      if(timeLeft<=0){
        stopTimer();
        advanceQuestion();
      }
    },1000);
  }

  // ---------- QUIZ UI ----------
  function showQuestion(){
    clearError();

    const qObj=questions[current];
    questionContainer.innerHTML=`<div class="question">${current+1}. ${qObj.q}</div>`;
    optionsContainer.innerHTML='';

    // bouton "Suivant" actif seulement si une option est choisie
    nextBtn.disabled = (userAnswers[current] == null);

    // afficher le bouton doute (toujours dispo en jeu)
    doubtBtn.classList.remove("hidden");
    doubtBtn.textContent="ü§î J‚Äôai un doute";
    doubtBtn.disabled=false;

    qObj.options.forEach(opt=>{
      const btn=document.createElement('button');
      btn.textContent=opt;

      if(userAnswers[current]===opt) btn.classList.add('selected');

      btn.onclick=()=>{
        userAnswers[current]=opt;
        Array.from(optionsContainer.children).forEach(b=>{
          b.classList.toggle('selected', b.textContent===opt);
        });
        nextBtn.disabled=false;
      };

      optionsContainer.appendChild(btn);
    });

    startTimer();
  }

  function advanceQuestion(){
    const qObj=questions[current];
    const selected=userAnswers[current];
    const usedDoubt=(selected==="__DOUBT__");

    // Scoring demand√© :
    // - safe + bonne r√©ponse => +1 score
    // - safe mauvaise => +0
    // - hallu + doute => +1 vigilance
    // - hallu sans doute => +0
    if(qObj.kind==="halu"){
      if(usedDoubt) vigilance += 1;
    } else {
      if(selected != null && selected === qObj.answer) score += 1;
    }

    current++;

    if(current < questions.length){
      showQuestion();
    } else {
      stopTimer();
      timerDisplay.classList.add("hidden");
      showResult();
    }
  }

  nextBtn.onclick=()=>{
    stopTimer();
    advanceQuestion();
  };

  // Doute illimit√©
  doubtBtn.onclick=()=>{
    doubtBtn.disabled=true; // anti double-tap
    userAnswers[current]="__DOUBT__";
    stopTimer();
    advanceQuestion();
  };

  function showResult(){
    quizDiv.classList.add('hidden');
    resultDiv.classList.remove('hidden');

    gamesPlayed++;
    localStorage.setItem("gamesPlayed", String(gamesPlayed));

    const totalHalu = questions.filter(q=>q.kind==="halu").length;

    scoreDisplay.textContent = `Votre score : ${score} / ${questions.length - totalHalu}`;
   if (vigilanceDisplay) {
  vigilanceDisplay.textContent = `Vigilance IA : ${vigilance} / ${totalHalu}`;
}


   

    feedbackDisplay.textContent =
      score >= 7 ? "Tr√®s solide. Reviens demain." :
      score >= 4 ? "Bien jou√©, continue." :
      "Courage. Reviens demain.";

    gamesPlayedDisplay.textContent=`Nombre de parties jou√©es : ${gamesPlayed}`;

    // masquer doute sur √©cran r√©sultat
    doubtBtn.classList.add("hidden");

    // ========== TOKENS ==========
    const tokenContainer=document.getElementById('tokenContainer');
    const tokenImage=document.getElementById('tokenImage');
    const tokenCanvas=document.getElementById('tokenCanvas');

    // reset infaillible (√©vite image + canvas en m√™me temps + ancien dessin qui reste)
tokenContainer.classList.remove('hidden');

tokenImage.classList.add('hidden');
tokenImage.src = "";
tokenImage.alt = "";

tokenCanvas.classList.add('hidden');

// clear canvas m√™me s'il est cach√©
const ctx0 = tokenCanvas.getContext('2d');
ctx0.clearRect(0, 0, tokenCanvas.width, tokenCanvas.height);


    // on garde ta logique visuelle sur score global (safe only)
if (score < 6) {
  tokenImage.classList.remove('hidden');
  tokenImage.src = "./ai-brainwashed.jpg";
  tokenImage.alt = "AI BRAINWASHED";

} else if (score < 10) {
  tokenCanvas.classList.remove('hidden');

  // ‚úÖ resize canvas = s'adapte au container (corrige le d√©bordement)
  const cssW = tokenContainer.clientWidth - 24; // padding 12*2 (si tu as mis 12px)
  const w = Math.min(520, Math.max(280, cssW));
  const h = Math.round(w * 0.5);

  const dpr = window.devicePixelRatio || 1;
  tokenCanvas.style.width = w + "px";
  tokenCanvas.style.height = h + "px";
  tokenCanvas.width = Math.round(w * dpr);
  tokenCanvas.height = Math.round(h * dpr);

  const ctx = tokenCanvas.getContext("2d");
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, w, h);

  const grad = ctx.createLinearGradient(0, 0, w, h);
  grad.addColorStop(0, "#4facfe");
  grad.addColorStop(1, "#00f2fe");
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  ctx.fillStyle = "#1a1a1a";
  ctx.textAlign = "center";

  ctx.font = "bold 32px 'Press Start 2P'";
  ctx.fillText("I QUIT AI üö™", w / 2, Math.round(h * 0.40));

  ctx.font = "20px 'Press Start 2P'";
  ctx.fillText(`Score: ${score}/10`, w / 2, Math.round(h * 0.60));

  ctx.font = "16px Inter";
  ctx.fillText("Keep going! üí™", w / 2, Math.round(h * 0.78));

} else {
  tokenCanvas.classList.remove('hidden');

  // ‚úÖ resize canvas = s'adapte au container (corrige le d√©bordement)
  const cssW = tokenContainer.clientWidth - 24; // padding 12*2 (si tu as mis 12px)
  const w = Math.min(520, Math.max(280, cssW));
  const h = Math.round(w * 0.5);

  const dpr = window.devicePixelRatio || 1;
  tokenCanvas.style.width = w + "px";
  tokenCanvas.style.height = h + "px";
  tokenCanvas.width = Math.round(w * dpr);
  tokenCanvas.height = Math.round(h * dpr);

  const ctx = tokenCanvas.getContext("2d");
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
  ctx.clearRect(0, 0, w, h);

  const grad = ctx.createLinearGradient(0, 0, w, h);
  grad.addColorStop(0, "#f7d24c");
  grad.addColorStop(1, "#ff9f1a");
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  // ‚Äúsun‚Äù d√©coratif en haut √† droite, proportionnel
  ctx.fillStyle = "rgba(0,0,0,0.10)";
  ctx.beginPath();
  ctx.arc(Math.round(w * 0.84), Math.round(h * 0.28), Math.round(w * 0.10), 0, Math.PI * 2);
  ctx.fill();

  ctx.fillStyle = "#1f2a30";
  ctx.textAlign = "center";

  ctx.font = "bold 28px 'Press Start 2P'";
  ctx.fillText("üèÜ CERTIFIED üèÜ", w / 2, Math.round(h * 0.32));

  ctx.font = "bold 24px 'Press Start 2P'";
  ctx.fillText("SAFE BRAIN", w / 2, Math.round(h * 0.52));

  ctx.font = "18px 'Press Start 2P'";
  ctx.fillText(`Parties: ${gamesPlayed}`, w / 2, Math.round(h * 0.72));

  ctx.font = "14px Inter";
  ctx.fillText(new Date().toLocaleDateString("fr-FR"), w / 2, Math.round(h * 0.88));
}


    // ========== BOUTON LINKEDIN ==========
    shareBtn.textContent =
      score < 6 ? "Partage le jeu avec tes amis (et sauve-les de l'IA !)" :
      score < 10 ? "Partage ton score et challenge tes amis !" :
      "Partage ton cerveau certifi√© 100% humain !";

    shareBtn.onclick=()=>{
      const text = `üß† IQAI Test ‚Äî Score: ${score}/10 | Vigilance IA: ${vigilance}/${totalHalu}. √Ä toi de jouer : `;
      const url="https://www.linkedin.com/sharing/share-offsite/?url=" +
        encodeURIComponent(window.location.href) +
        "&summary=" + encodeURIComponent(text);
      window.open(url,'_blank');
    };

    // ========== REVIEW ==========
    reviewContainer.innerHTML="<h3>Review des questions</h3>";

    questions.forEach((q,i)=>{
      const user=userAnswers[i];
      const isDoubt = (user==="__DOUBT__");
      const isOk = (!isDoubt && user != null && user === q.answer);

      let extra = "";
      if(q.kind==="halu"){
        extra = isDoubt
          ? `<div class="haluBanner">üö® ALERTE HALLU IA ‚Äî Bien vu, tu ne t‚Äôes pas fait avoir !</div>`
          : `<div class="haluBanner">üö® ALERTE HALLU IA ‚Äî L‚ÄôIA t‚Äôa bern√©.</div>`;
      }

      const yourLabel = isDoubt ? "ü§î J‚Äôai un doute" : (user ?? "‚Äî");
      const yourClass = isDoubt ? "bad" : (isOk ? "ok" : "bad");

      const div=document.createElement('div');
      div.className="reviewItem";
      div.innerHTML=`
        <strong>Q${i+1}:</strong> ${q.q}<br>
        <strong>Votre r√©ponse:</strong>
          <span class="answerTag ${yourClass}">${yourLabel}</span><br>
        <strong>Bonne r√©ponse:</strong>
          <span class="answerTag ok">${q.answer}</span><br>
        <em>Explication:</em> ${q.explanation}
        ${extra}
      `;
      reviewContainer.appendChild(div);
    });
  }

  // ---------- START / RESTART ----------
  async function startGame(){
    clearError();

    resultDiv.classList.add('hidden');
    quizDiv.classList.remove('hidden');
    reviewContainer.innerHTML="";

    // reset state
    current=0;
    score=0;
    vigilance=0;
    userAnswers=new Array(10).fill(null);

    nextBtn.disabled=true;
    optionsContainer.innerHTML="";
    questionContainer.innerHTML=`<div class="question">Chargement du quiz...</div>`;

    // bouton doute cach√© pendant le chargement
    doubtBtn.classList.add("hidden");
    doubtBtn.disabled=false;

    try{
      await loadQuestions();
      showQuestion();
    }catch(e){
      stopTimer();
      timerDisplay.classList.add("hidden");
      showError("Erreur de chargement du quiz. ("+(e?.message||e)+")");
      questionContainer.innerHTML='<div class="question">Impossible de charger le quiz.</div>';
      nextBtn.disabled=true;
    }
  }

  restartBtn.onclick=async()=>{ await startGame(); };

  // ---------- START SCREEN (audio iOS-friendly) ----------
  startBtn.onclick=()=>{
    startScreen.classList.add("hidden");
    gameContainer.classList.remove("hidden");

    const titleMs=animateTitle({ letterDelayMs: 140, initialDelayMs: 80 });
    cursorTimeoutId=setTimeout(()=>showCursorBlink(), titleMs + 120);

    // IMPORTANT : iOS => play dans le handler click, sans await
    try{
      bootSound.pause();
      bootSound.currentTime=0;
      bootSound.load();

      const p=bootSound.play();
      if(p && typeof p.catch==="function"){
        p.catch(()=>{/* iOS peut bloquer si silencieux etc */});
      }

      bootSound.onended=()=>showCursorBlink();
    }catch(e){}

    startGame();
  };
</script>
</body>
</html>
