<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IQAI Test - I Quit AI</title>
<link rel="icon" href="data:,">

<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- OneSignal Push Notifications -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(async function(OneSignal) {
    await OneSignal.init({
      appId: "dc73bf96-dbcf-4498-ab4d-5639c66b16ea",
    });
  });
</script>

<style>
  *{box-sizing:border-box;margin:0;padding:0;}
  :root{
    --title-font:'Press Start 2P', monospace;
    --body-font:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  body{
    min-height:100vh;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    background: linear-gradient(135deg,#f0c79e,#e3a56b);
    padding:20px;
    font-family: var(--body-font);
  }

  h1{
    font-family: var(--title-font);
    font-size:2.25em;
    margin-bottom:8px;
    text-align:center;
    line-height:1.15;
    letter-spacing:0.5px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.18);
    white-space: nowrap;
  }
  h1 span{display:inline-block;}

  .title-sep{
    margin:0 10px;
    opacity:0;
    transform:translateY(-1px);
    color: rgba(255,255,255,0.92);
  }
  .title-sep.cursor-on{
    opacity:0.92;
    animation: caretBlink 1.7s steps(1,end) infinite;
  }
  @keyframes caretBlink{
    0%,49%{opacity:0.92;}
    50%,100%{opacity:0;}
  }

  p.subtitle{
    text-align:center;
    margin-bottom:24px;
    font-size:1.45em;
    font-weight:800;
    color:#ffffff;
    text-shadow:0 3px 12px rgba(0,0,0,0.28);
    letter-spacing:0.2px;
  }

  .container{
    max-width:560px;width:100%;
    background:#ffffff;color:#333;
    border-radius:18px;
    padding:26px;
    box-shadow:0 10px 28px rgba(0,0,0,0.18);
  }

  .question{
    margin-bottom:14px;
    font-weight:800;
    font-size:1.05em;
    line-height:1.35;
  }

  .options button{
    margin:6px 0;
    width:100%;
    padding:12px 14px 12px 44px;
    border:none;
    border-radius:12px;
    background:#ff8f00;
    color:#fff;
    cursor:pointer;
    font-weight:800;
    transition:0.2s;
    position:relative;
    text-align:left;
    font-family:var(--body-font);
    font-size:1em;
  }
  .options button:hover{background:#f57c00;}

  .options button.selected{
    background:#263238 !important;
    outline:3px solid rgba(255,143,0,0.55);
    box-shadow:0 8px 18px rgba(0,0,0,0.15);
    transform:translateY(1px);
  }
  .options button::before{
    content:"";
    position:absolute;left:12px;top:50%;
    transform:translateY(-50%);
    width:20px;height:20px;border-radius:6px;
    border:2px solid rgba(255,255,255,0.85);
    background:rgba(255,255,255,0.12);
  }
  .options button.selected::before{
    content:"‚úì";
    display:flex;align-items:center;justify-content:center;
    font-weight:900;color:#fff;
    background:rgba(255,255,255,0.25);
  }

  #nextBtn{
    margin-top:12px;width:100%;
    padding:12px;border:none;border-radius:12px;
    background:#263238;color:#fff;
    cursor:pointer;font-weight:800;
    transition:0.2s;
    font-family:var(--body-font);
    font-size:1em;
  }
  #nextBtn:hover{filter:brightness(1.05);}
  #nextBtn:disabled{opacity:0.55;cursor:not-allowed;}

  .score,.streak,.feedback{text-align:center;margin-top:10px;}
  .feedback{font-style:italic;color:#27ae60;font-weight:800;}

  #shareBtn, #restartBtn{
    margin-top:12px;width:100%;
    padding:12px;border:none;border-radius:12px;
    cursor:pointer;font-weight:900;
    font-size:1em;
  }
  
  #restartBtn{
    background:#263238;color:#fff;
  }
  #restartBtn:hover{filter:brightness(1.05);}
  
  #shareBtn{
    background:#0077b5;color:#fff;
  }
  #shareBtn:hover { background: #005885; }

  .hidden{display:none;}

  #reviewContainer{margin-top:18px;}
  #reviewContainer h3{margin:8px 0 10px;font-size:1.05em;}
  .reviewItem{
    padding:10px 12px;
    border:1px solid rgba(0,0,0,0.08);
    border-radius:12px;margin-bottom:10px;
    background:rgba(0,0,0,0.02);
    line-height:1.35;
    font-size:0.98em;
  }

  .errorBox{
    margin-top:10px;
    padding:12px;
    border-radius:12px;
    background:#fff3f3;
    border:1px solid rgba(255,0,0,0.15);
    color:#8a1f1f;
    font-weight:700;
    line-height:1.35;
    font-size:0.98em;
  }

  .answerTag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-weight:900;
    line-height:1.2;
  }
  .answerTag.ok{
    background: rgba(39,174,96,0.12);
    border: 1px solid rgba(39,174,96,0.35);
    color:#1f7a3f;
  }
  .answerTag.bad{
    background: rgba(255,60,120,0.14);
    border: 1px solid rgba(255,60,120,0.40);
    color:#a8164a;
  }

  .haluBanner{
    margin-top:8px;
    padding:8px 10px;
    border-radius:12px;
    font-weight:900;
    background: rgba(255, 60, 120, 0.12);
    border: 1px solid rgba(255, 60, 120, 0.35);
    color:#a8164a;
    line-height:1.5;
  }

  #tokenContainer{
    width: min(520px, 100%);
    margin: 0 auto 16px auto;
    padding: 10px;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    overflow: hidden;
  }

  #tokenImage{
    display:block;
    width:100%;
    height:auto;
    border-radius:14px;
    object-fit: cover;
  }

  #tokenCanvas{
    display:block;
    width:100%;
    height:auto;
    border-radius:14px;
  }

  #startBtn{
    width:100%;
    padding:16px;
    font-size:1.05em;
    font-weight:900;
    border:none;
    border-radius:14px;
    background: linear-gradient(#2f3a41, #1f2a30);
    color:#fff;
    cursor:pointer;
    transition:0.2s;
    font-family: var(--title-font);
    letter-spacing:0.5px;
    box-shadow:
      inset 0 2px 0 rgba(255,255,255,0.12),
      inset 0 -3px 0 rgba(0,0,0,0.25),
      0 10px 28px rgba(0,0,0,0.18);
    border: 2px solid rgba(255,255,255,0.12);
  }
  #startBtn:active{
    transform: translateY(2px);
    box-shadow:
      inset 0 2px 0 rgba(255,255,255,0.10),
      inset 0 -2px 0 rgba(0,0,0,0.22),
      0 6px 18px rgba(0,0,0,0.18);
  }
  #startBtn:hover{filter:brightness(1.05);}

  #timerLine{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:10px;
  }
  #timerDisplay{
    font-family: var(--title-font);
    font-size: 0.82em;
    color: #1f2a30;
    background: rgba(255, 143, 0, 0.18);
    border: 2px solid rgba(255, 143, 0, 0.45);
    box-shadow: inset 0 2px 0 rgba(255,255,255,0.35);
    padding: 7px 12px;
    border-radius: 999px;
  }
  #timerDisplay.timer-urgent{
    background: rgba(255, 60, 120, 0.16);
    border-color: rgba(255, 60, 120, 0.55);
    color: #a8164a;
  }

  #doubtBtn{
    margin-top:10px;
    width:100%;
    padding:12px;
    border-radius:12px;
    border:2px dashed rgba(255,143,0,0.8);
    background:#fff3e0;
    font-weight:900;
    cursor:pointer;
    font-family: var(--body-font);
  }
  #doubtBtn:active{transform: translateY(1px);}
  #doubtBtn:disabled{opacity:0.55;cursor:not-allowed;}

  .cooldownMessage{
    text-align:center;
    padding:20px;
    background:rgba(255,143,0,0.12);
    border-radius:12px;
    margin-top:16px;
  }
  .cooldownMessage h2{
    font-size:1.5em;
    margin-bottom:12px;
    color:#263238;
  }
  .cooldownMessage p{
    font-size:1.1em;
    line-height:1.5;
    color:#555;
  }

  @media (max-width: 420px){
    h1{font-size:1.45em;letter-spacing:0.2px;}
    .title-sep{margin:0 6px;}
    p.subtitle{font-size:1.15em;}
  }
</style>
</head>

<body>
  <h1 id="title"></h1>
  <p class="subtitle">I Quit AI</p>

  <div id="startScreen" class="container">
    <h2 style="text-align:center;margin-bottom:16px;font-weight:900;">Appuie pour d√©marrer</h2>
    <button id="startBtn">‚ñ∂ START</button>
  </div>

  <div class="container hidden" id="gameContainer">
    <div id="quiz">
      <div id="timerLine">
        <div></div>
        <div id="timerDisplay" class="hidden">‚è± 30</div>
      </div>

      <div id="questionContainer"></div>
      <div class="options" id="optionsContainer"></div>

      <button id="nextBtn" disabled>Suivant</button>
      <button id="doubtBtn" class="hidden">ü§î J'ai un doute</button>

      <div id="errorContainer" class="hidden"></div>
    </div>

    <div id="result" class="hidden">
      <!-- TOKEN EN HAUT -->
      <div id="tokenContainer" class="hidden">
        <img id="tokenImage" class="hidden" />
        <canvas id="tokenCanvas" class="hidden" width="500" height="250"></canvas>
      </div>

      <!-- D√âTAILS DU SCORE -->
      <div id="scoreDetails" style="text-align:center; margin-bottom:16px;"></div>
      
      <p class="feedback" id="feedbackDisplay"></p>
      <p class="streak" id="gamesPlayedDisplay"></p>

      <!-- BOUTONS REJOUER / PARTAGER -->
      <button id="restartBtn">üîÑ Rejouer demain</button>
      <button id="shareBtn">üì§ Partager sur LinkedIn</button>

      <!-- REVIEW DES QUESTIONS -->
      <div id="reviewContainer"></div>
      
      <!-- COMMENT √áA MARCHE (tout en bas) -->
      <div id="howItWorks" style="margin-top:20px; padding:12px; background:rgba(255,143,0,0.12); border-radius:10px; font-size:0.92em; line-height:1.5;">
        <strong>üìä Comment √ßa marche ?</strong><br>
        ‚úÖ Bonne r√©ponse (safe) = +1 point<br>
        ‚úÖ Hallu d√©tect√©e (doute) = +1 point<br>
        ‚ùå Mauvaise r√©ponse = 0 point<br>
        ‚ùå Hallu rat√©e (pas de doute) = 0 point
      </div>
    </div>
  </div>

  <audio id="bootSound" preload="auto" playsinline>
    <source src="Gameboy.mp3" type="audio/mpeg">
  </audio>

<script>
  // ---------- TITLE ----------
  const colors=["#FF4136","#FFDC00","#2ECC40","#0074D9","#FF851B","#B10DC9"];
  const titleContainer=document.getElementById("title");
  const parts=["IQAI","Test"];

  let cursorSepEl=null;
  let cursorTimeoutId=null;
  let hasShownCursor=false;

  function clearTitle(){
    titleContainer.innerHTML="";
    cursorSepEl=null;
    hasShownCursor=false;
    if(cursorTimeoutId){clearTimeout(cursorTimeoutId);cursorTimeoutId=null;}
  }
  function showCursorBlink(){
    if(hasShownCursor) return;
    if(cursorSepEl){
      cursorSepEl.classList.add("cursor-on");
      hasShownCursor=true;
    }
  }
  function animateTitle({ letterDelayMs=140, initialDelayMs=80 }={}){
    clearTitle();

    const spans=[];
    let colorIndex=0;

    function addColoredText(text){
      text.split("").forEach((c,i)=>{
        const s=document.createElement("span");
        s.textContent=c;
        s.style.opacity="0";
        s.style.transform="scale(0.85)";
        s.style.transition="opacity 180ms ease, transform 180ms ease";
        s.style.color=colors[(colorIndex+i)%colors.length];
        spans.push(s);
        titleContainer.appendChild(s);
      });
      colorIndex+=text.length;
    }

    addColoredText(parts[0]);

    cursorSepEl=document.createElement("span");
    cursorSepEl.className="title-sep";
    cursorSepEl.textContent="|";
    titleContainer.appendChild(cursorSepEl);

    addColoredText(parts[1]);

    spans.forEach((s,i)=>{
      setTimeout(()=>{
        s.style.opacity="1";
        s.style.transform="scale(1)";
      }, initialDelayMs + (i*letterDelayMs));
    });

    return initialDelayMs + (spans.length*letterDelayMs) + 220;
  }

  // ---------- STATE ----------
  const API_URL="https://iqai-backend.vercel.app/api/quiz";
  let questions=[];
  let current=0;
  let score=0;
  let vigilance=0;
  let userAnswers=[];

  const QUESTION_TIME=30;
  let timeLeft=QUESTION_TIME;
  let timerId=null;

  // ---------- DOM ----------
  const questionContainer=document.getElementById('questionContainer');
  const optionsContainer=document.getElementById('optionsContainer');
  const nextBtn=document.getElementById('nextBtn');
  const doubtBtn=document.getElementById('doubtBtn');
  const quizDiv=document.getElementById('quiz');
  const resultDiv=document.getElementById('result');

  const scoreDetails=document.getElementById('scoreDetails');
  const feedbackDisplay=document.getElementById('feedbackDisplay');
  const gamesPlayedDisplay=document.getElementById('gamesPlayedDisplay');

  const shareBtn=document.getElementById('shareBtn');
  const restartBtn=document.getElementById('restartBtn');
  const reviewContainer=document.getElementById('reviewContainer');
  const errorContainer=document.getElementById('errorContainer');

  const timerDisplay=document.getElementById("timerDisplay");

  const startScreen=document.getElementById("startScreen");
  const startBtn=document.getElementById("startBtn");
  const gameContainer=document.getElementById("gameContainer");
  const bootSound=document.getElementById("bootSound");

  let gamesPlayed=parseInt(localStorage.getItem("gamesPlayed")||"0",10);

  // ---------- COOLDOWN MINUIT √Ä MINUIT ----------
  function checkCooldown(){
    const lastPlayed=localStorage.getItem("lastPlayedDate");
    if(!lastPlayed) return true;
    
    const lastDate=new Date(lastPlayed);
    const now=new Date();
    
    // V√©rifier si on est un jour diff√©rent
    const lastDay = lastDate.toDateString();
    const nowDay = now.toDateString();
    
    return lastDay !== nowDay;
  }

  function setLastPlayed(){
    localStorage.setItem("lastPlayedDate", new Date().toISOString());
  }

  function getNextPlayTime(){
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(0, 0, 0, 0);
    return tomorrow;
  }

  // ---------- HELPERS ----------
  function showError(msg){
    errorContainer.classList.remove('hidden');
    errorContainer.className="errorBox";
    errorContainer.textContent=msg;
  }
  function clearError(){
    errorContainer.classList.add('hidden');
    errorContainer.className="";
    errorContainer.textContent="";
  }

  function normalizeQuiz(raw){
    if(!Array.isArray(raw)) return null;
    const arr=raw.slice(0,10).map(x=>({
      q:String(x.q??""),
      options:Array.isArray(x.options)?x.options.map(String).slice(0,4):[],
      answer:String(x.answer??""),
      explanation:String(x.explanation??""),
      kind:String(x.kind??"safe")
    })).filter(x=>x.q && x.options.length===4 && x.answer);
    return (arr.length===10)?arr:null;
  }

  async function fetchWithTimeout(url, options={}, ms=30000){
    const controller=new AbortController();
    const id=setTimeout(()=>controller.abort(), ms);
    try{
      return await fetch(url,{...options, signal:controller.signal});
    } finally {
      clearTimeout(id);
    }
  }

  async function loadQuestions(){
    const usedQuestions = JSON.parse(localStorage.getItem('usedQuestions') || '[]');
    
    const opts={
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      cache:"no-store",
      body: JSON.stringify({ avoid: usedQuestions.slice(-30) })
    };

    let res;
    try{
      res=await fetchWithTimeout(API_URL, opts, 30000);
    }catch(e){
      res=await fetchWithTimeout(API_URL, opts, 35000);
    }

    if(!res || !res.ok) throw new Error("Le backend ne r√©pond pas (HTTP "+(res?res.status:"‚Äî")+").");

    const raw=await res.json();
    const quiz=normalizeQuiz(raw);
    if(!quiz) throw new Error("Quiz invalide.");
    questions=quiz;
    
    const newQuestions = questions.map(q => q.q);
    const updated = [...usedQuestions, ...newQuestions].slice(-100);
    localStorage.setItem('usedQuestions', JSON.stringify(updated));
  }

  // ---------- TIMER ----------
  function stopTimer(){
    if(timerId){clearInterval(timerId);timerId=null;}
  }
  function startTimer(){
    stopTimer();
    timeLeft=QUESTION_TIME;
    timerDisplay.classList.remove("hidden");
    timerDisplay.textContent=`‚è± ${timeLeft}`;
    timerDisplay.classList.remove("timer-urgent");

    timerId=setInterval(()=>{
      timeLeft--;
      timerDisplay.textContent=`‚è± ${timeLeft}`;

      if(timeLeft<=10) timerDisplay.classList.add("timer-urgent");
      else timerDisplay.classList.remove("timer-urgent");

      if(timeLeft<=0){
        stopTimer();
        advanceQuestion();
      }
    },1000);
  }

  // ---------- QUIZ UI ----------
  function showQuestion(){
    clearError();

    const qObj=questions[current];
    questionContainer.innerHTML=`<div class="question">${current+1}. ${qObj.q}</div>`;
    optionsContainer.innerHTML='';

    nextBtn.disabled = (userAnswers[current] == null);

    doubtBtn.classList.remove("hidden");
    doubtBtn.textContent="ü§î J'ai un doute";
    doubtBtn.disabled=false;

    qObj.options.forEach(opt=>{
      const btn=document.createElement('button');
      btn.textContent=opt;

      if(userAnswers[current]===opt) btn.classList.add('selected');

      btn.onclick=()=>{
        userAnswers[current]=opt;
        Array.from(optionsContainer.children).forEach(b=>{
          b.classList.toggle('selected', b.textContent===opt);
        });
        nextBtn.disabled=false;
      };

      optionsContainer.appendChild(btn);
    });

    startTimer();
  }

  function advanceQuestion(){
    const qObj=questions[current];
    const selected=userAnswers[current];
    const usedDoubt=(selected==="__DOUBT__");

    if(qObj.kind==="halu"){
      if(usedDoubt) vigilance += 1;
    } else {
      if(selected != null && selected === qObj.answer) score += 1;
    }

    current++;

    if(current < questions.length){
      showQuestion();
    } else {
      stopTimer();
      timerDisplay.classList.add("hidden");
      setLastPlayed();
      showResult();
    }
  }

  nextBtn.onclick=()=>{
    stopTimer();
    advanceQuestion();
  };

  doubtBtn.onclick=()=>{
    doubtBtn.disabled=true;
    userAnswers[current]="__DOUBT__";
    stopTimer();
    advanceQuestion();
  };

  function showResult(){
    quizDiv.classList.add('hidden');
    resultDiv.classList.remove('hidden');

    gamesPlayed++;
    localStorage.setItem("gamesPlayed", String(gamesPlayed));

    const totalHalu = questions.filter(q=>q.kind==="halu").length;
    const totalSafe = questions.length - totalHalu;
    const scoreTotal = score + vigilance;
    const scoreMax = questions.length;

    // ========== TOKENS EN HAUT ==========
    const tokenContainer=document.getElementById('tokenContainer');
    const tokenImage=document.getElementById('tokenImage');
    const tokenCanvas=document.getElementById('tokenCanvas');

    tokenContainer.classList.remove('hidden');
    tokenImage.classList.add('hidden');
    tokenImage.src = "";
    tokenCanvas.classList.add('hidden');
    
    const ctx0 = tokenCanvas.getContext('2d');
    ctx0.clearRect(0, 0, tokenCanvas.width, tokenCanvas.height);

    if (scoreTotal < 6) {
      tokenImage.classList.remove('hidden');
      tokenImage.src = "./ai-brainwashed.jpg";
      tokenImage.alt = "AI BRAINWASHED";

    } else if (scoreTotal < 10) {
      tokenCanvas.classList.remove('hidden');

      const cssW = Math.min(500, tokenContainer.clientWidth - 20);
      const w = cssW;
      const h = Math.round(w * 0.48);

      const dpr = window.devicePixelRatio || 1;
      tokenCanvas.style.width = w + "px";
      tokenCanvas.style.height = h + "px";
      tokenCanvas.width = Math.round(w * dpr);
      tokenCanvas.height = Math.round(h * dpr);

      const ctx = tokenCanvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, w, h);

      const grad = ctx.createLinearGradient(0, 0, w, h);
      grad.addColorStop(0, "#4facfe");
      grad.addColorStop(1, "#00f2fe");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      ctx.fillStyle = "#1a1a1a";
      ctx.textAlign = "center";

      ctx.font = "bold 32px 'Press Start 2P'";
      ctx.fillText("I QUIT AI üö™", w / 2, Math.round(h * 0.38));

      ctx.font = "24px 'Press Start 2P'";
      ctx.fillText(`${scoreTotal}/${scoreMax}`, w / 2, Math.round(h * 0.62));

      ctx.font = "16px Inter";
      ctx.fillText("Keep going! üí™", w / 2, Math.round(h * 0.82));

    } else {
      tokenCanvas.classList.remove('hidden');

      const cssW = Math.min(500, tokenContainer.clientWidth - 20);
      const w = cssW;
      const h = Math.round(w * 0.48);

      const dpr = window.devicePixelRatio || 1;
      tokenCanvas.style.width = w + "px";
      tokenCanvas.style.height = h + "px";
      tokenCanvas.width = Math.round(w * dpr);
      tokenCanvas.height = Math.round(h * dpr);

      const ctx = tokenCanvas.getContext("2d");
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.clearRect(0, 0, w, h);

      const grad = ctx.createLinearGradient(0, 0, w, h);
      grad.addColorStop(0, "#f7d24c");
      grad.addColorStop(1, "#ff9f1a");
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, w, h);

      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.beginPath();
      ctx.arc(Math.round(w * 0.84), Math.round(h * 0.28), Math.round(w * 0.10), 0, Math.PI * 2);
      ctx.fill();

      ctx.fillStyle = "#1f2a30";
      ctx.textAlign = "center";

      ctx.font = "bold 26px 'Press Start 2P'";
      ctx.fillText("üèÜ CERTIFIED üèÜ", w / 2, Math.round(h * 0.30));

      ctx.font = "bold 22px 'Press Start 2P'";
      ctx.fillText("SAFE BRAIN", w / 2, Math.round(h * 0.50));

      ctx.font = "20px 'Press Start 2P'";
      ctx.fillText(`${scoreTotal}/${scoreMax}`, w / 2, Math.round(h * 0.68));

      ctx.font = "14px Inter";
      ctx.fillText(`Parties: ${gamesPlayed}`, w / 2, Math.round(h * 0.84));
    }

    // ========== D√âTAILS DU SCORE ==========
    scoreDetails.innerHTML = `
      <div style="font-size:1em; margin-bottom:6px;">
        üìö Questions classiques : <strong>${score} / ${totalSafe}</strong>
      </div>
      <div style="font-size:1em;">
        üö® Hallus d√©tect√©es : <strong>${vigilance} / ${totalHalu}</strong>
      </div>
    `;

    feedbackDisplay.textContent =
      scoreTotal >= 8 ? "Tr√®s solide. Reviens demain." :
      scoreTotal >= 5 ? "Bien jou√©, continue." :
      "Courage. Reviens demain.";

    gamesPlayedDisplay.textContent=`Nombre de parties jou√©es : ${gamesPlayed}`;

    doubtBtn.classList.add("hidden");

    // ========== POPUP ONESIGNAL AUTOMATIQUE ==========
    // Demander la permission d√®s la fin du quiz
    setTimeout(() => {
      if (window.OneSignal) {
        OneSignalDeferred.push(async function(OneSignal) {
          try {
            const isPushSupported = await OneSignal.Notifications.isPushSupported();
            if (isPushSupported) {
              const permission = await OneSignal.Notifications.permission;
              if (!permission) {
                await OneSignal.Slidedown.promptPush();
              }
            }
          } catch(e) {
            console.log('OneSignal error:', e);
          }
        });
      }
    }, 1500); // Attendre 1.5s pour laisser le joueur voir son score d'abord

    // ========== BOUTONS ==========
    restartBtn.onclick=()=>{ 
      const canPlay=checkCooldown();
      if(!canPlay){
        const nextTime=getNextPlayTime();
        const now = new Date();
        const diff = nextTime - now;
        const hours=Math.floor(diff/(1000*60*60));
        const minutes=Math.floor((diff%(1000*60*60))/(1000*60));
        alert(`‚è∞ Tu as d√©j√† jou√© aujourd'hui ! Reviens √† minuit (dans ${hours}h ${minutes}min)`);
        return;
      }
      location.reload();
    };

    shareBtn.textContent = "üì§ Partager sur LinkedIn";
    shareBtn.onclick=()=>{
      const text = `üß† IQAI Test ‚Äî Score: ${scoreTotal}/${scoreMax} (${score} safe + ${vigilance} hallus). D√©fi quotidien ! √Ä toi de jouer : `;
      const url="https://www.linkedin.com/sharing/share-offsite/?url=" +
        encodeURIComponent(window.location.href) +
        "&summary=" + encodeURIComponent(text);
      window.open(url,'_blank');
    };

    // ========== REVIEW ==========
    reviewContainer.innerHTML="<h3>Review des questions</h3>";

    questions.forEach((q,i)=>{
      const user=userAnswers[i];
      const isDoubt = (user==="__DOUBT__");
      const isOk = (!isDoubt && user != null && user === q.answer);

      let extra = "";
      if(q.kind==="halu"){
        if(isDoubt) {
          extra = `<div class="haluBanner">
            üö® <strong>ALERTE HALLU IA</strong> ‚Äî Bien vu ! Tu as rep√©r√© le pi√®ge.<br>
            <em>Cette question contenait une incoh√©rence volontaire. Il n'y avait pas de bonne r√©ponse.</em><br>
            ‚úÖ <strong>+1 point de vigilance</strong>
          </div>`;
        } else {
          extra = `<div class="haluBanner">
            üö® <strong>ALERTE HALLU IA</strong> ‚Äî L'IA t'a bern√©.<br>
            <em>Cette question contenait une incoh√©rence volontaire. Il fallait cliquer sur "J'ai un doute".</em><br>
            ‚ùå <strong>0 point</strong>
          </div>`;
        }
      }

      const yourLabel = isDoubt ? "ü§î J'ai un doute" : (user ?? "‚Äî");
      const yourClass = isDoubt ? "bad" : (isOk ? "ok" : "bad");

      const goodAnswerText = q.kind === "halu" 
        ? "ü§î J'ai un doute (seule r√©ponse valide)" 
        : q.answer;

      const div=document.createElement('div');
      div.className="reviewItem";
      div.innerHTML=`
        <strong>Q${i+1}:</strong> ${q.q}<br>
        <strong>Votre r√©ponse:</strong>
          <span class="answerTag ${yourClass}">${yourLabel}</span><br>
        <strong>Bonne r√©ponse:</strong>
          <span class="answerTag ok">${goodAnswerText}</span><br>
        <em>Explication:</em> ${q.explanation}
        ${extra}
      `;
      reviewContainer.appendChild(div);
    });
  }

  // ---------- START / RESTART ----------
  async function startGame(){
    // V√©rifier cooldown
    if(!checkCooldown()){
      const nextTime=getNextPlayTime();
      const now = new Date();
      const diff = nextTime - now;
      const hours=Math.floor(diff/(1000*60*60));
      const minutes=Math.floor((diff%(1000*60*60))/(1000*60));
      
      quizDiv.innerHTML=`
        <div class="cooldownMessage">
          <h2>‚è∞ Reviens demain !</h2>
          <p>Tu as d√©j√† jou√© aujourd'hui.<br>
          Prochaine partie √† <strong>minuit</strong> (dans ${hours}h ${minutes}min)</p>
          <button onclick="location.reload()" style="margin-top:16px; padding:10px 20px; background:#263238; color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:900;">üîÑ Rafra√Æchir</button>
        </div>
      `;
      return;
    }

    clearError();

    resultDiv.classList.add('hidden');
    quizDiv.classList.remove('hidden');
    reviewContainer.innerHTML="";

    current=0;
    score=0;
    vigilance=0;
    userAnswers=new Array(10).fill(null);

    nextBtn.disabled=true;
    optionsContainer.innerHTML="";
    questionContainer.innerHTML=`<div class="question">Chargement du quiz...</div>`;

    doubtBtn.classList.add("hidden");
    doubtBtn.disabled=false;

    try{
      await loadQuestions();
      showQuestion();
    }catch(e){
      stopTimer();
      timerDisplay.classList.add("hidden");
      showError("Erreur de chargement du quiz. ("+(e?.message||e)+")");
      questionContainer.innerHTML='<div class="question">Impossible de charger le quiz.</div>';
      nextBtn.disabled=true;
    }
  }

  restartBtn.onclick=async()=>{ await startGame(); };

  // ---------- START SCREEN ----------
  startBtn.onclick=()=>{
    startScreen.classList.add("hidden");
    gameContainer.classList.remove("hidden");

    const titleMs=animateTitle({ letterDelayMs: 140, initialDelayMs: 80 });
    cursorTimeoutId=setTimeout(()=>showCursorBlink(), titleMs + 120);

    try{
      bootSound.pause();
      bootSound.currentTime=0;
      bootSound.load();

      const p=bootSound.play();
      if(p && typeof p.catch==="function"){
        p.catch(()=>{});
      }

      bootSound.onended=()=>showCursorBlink();
    }catch(e){}

    startGame();
  };
</script>
</body>
</html>
